<!doctype html>
<meta charset="utf-8" />
<title>TSV → herbs.json</title>
<style>
  body{font:16px/1.4 system-ui,Segoe UI,Arial,sans-serif;max-width:900px;margin:40px auto;padding:0 16px}
  textarea{width:100%;height:320px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  button{padding:10px 16px;border-radius:10px;border:1px solid #444;background:#111;color:#fff;cursor:pointer}
  label{font-weight:600}
</style>
<h1>TSV → herbs.json</h1>
<p>Paste your TSV with columns: <code>Finnish	English	Latin	Category	Availability	Toxicity	Use notes</code></p>

<div class="row">
  <label>Default language:</label>
  <select id="lang">
    <option value="fi" selected>fi</option>
    <option value="en">en</option>
  </select>
  <button id="convert">Convert & Download</button>
</div>

<textarea id="tsv" placeholder="Paste TSV here…"></textarea>

<script>
function slugify(s){
  return s.toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').slice(0,48);
}
function mapOrigin(avail){
  const a = (avail||'').toLowerCase().trim();
  return {
    native_in_finland: a==='native' || a==='naturalized',
    store_bought: a==='store' || a==='store/garden'
  };
}
function emptyPair(){ return { fi:"", en:"" }; }

document.getElementById('convert').onclick = () => {
  const tsv = document.getElementById('tsv').value.trim();
  if(!tsv){ alert('Paste TSV first'); return;}
  const lines = tsv.split(/\r?\n/).filter(Boolean);
  const herbs = [];
  for(const line of lines){
    // Expect: Finnish  English  Latin  Category  Availability  Toxicity  Use notes
    const cols = line.split('\t');
    if(cols.length < 7){
      console.warn('Skipping (not 7 columns):', line);
      continue;
    }
    const [fiName, enName, latin, category, availability, toxicity, useNotes] = cols.map(s=>s.trim());

    const idBase = latin || fiName || enName || Math.random().toString(36).slice(2);
    const id = slugify(idBase || fiName);

    const origin = mapOrigin(availability);

    // Minimal fields your app already knows how to show; others left blank.
    const found = emptyPair();
    const parts_used = emptyPair();
    const uses_make = { fi: useNotes || "", en: (enName? (useNotes || "") : "") };
    const safety = { fi: (toxicity && toxicity!=="safe" ? `Varoitus: ${toxicity}.` : ""), en: (toxicity && toxicity!=="safe" ? `Caution: ${toxicity}.` : "") };
    const other = emptyPair();

    herbs.push({
      id,
      name: { fi: fiName || enName || latin, en: enName || "" },
      scientific_name: latin,
      origin,
      availability: availability,        // keep raw value too (handy)
      category: category,                // e.g. medicinal / culinary / poisonous
      toxicity: toxicity,                // safe / mild / moderate / high
      found,
      parts_used,
      uses_make,
      safety,
      other
    });
  }

  const out = {
    version: 2,
    language_default: document.getElementById('lang').value || "fi",
    herbs
  };

  const blob = new Blob([JSON.stringify(out,null,2)], {type:"application/json"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'herbs.json';
  a.click();
  URL.revokeObjectURL(a.href);
};
</script>
