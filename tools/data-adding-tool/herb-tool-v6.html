<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Herb Card – Load & Merge</title>
<style>
  :root { --bg:#0f0f13; --fg:#f4f4f6; --muted:#bdbdc7; --accent:#ff99c8; --ok:#60d394; --warn:#ffd166; --bad:#ef476f; --card:#17171d; }
  body { background:var(--bg); color:var(--fg); font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; padding:24px }
  h1 { font-size:20px; margin:0 0 12px }
  .row { display:grid; grid-template-columns:1fr 520px; gap:16px }
  .card { background:var(--card); border:1px solid #262633; border-radius:14px; padding:14px }
  .section { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:6px 0 10px }
  .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #2a2a36; color:var(--muted) }
  .pill.ok { color:#0f4125; background:var(--ok); border-color:transparent }
  .pill.warn { color:#403106; background:var(--warn); border-color:transparent }
  .pill.bad { color:#4a0c17; background:var(--bad); border-color:transparent }
  textarea { width:100%; min-height:300px; resize:vertical; background:#0b0b10; color:var(--fg); border:1px solid #2a2a36; border-radius:10px; padding:12px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace }
  pre { margin:0; white-space:pre-wrap; word-break:break-word; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace }
  button { background:#1f1f28; color:var(--fg); border:1px solid #2a2a36; padding:9px 12px; border-radius:10px; cursor:pointer }
  button:hover { border-color:#3a3a48 }
  label { color:var(--muted); font-size:14px }
  input[type="file"] { accent-color:var(--accent) }
  .kv { display:grid; grid-template-columns: 160px 1fr; gap:8px; align-items:start; margin-bottom:6px }
  .kv b { color:var(--muted) }
  .grid { display:grid; grid-template-columns:1fr; gap:10px }
  .mono { font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace }
</style>
</head>
<body>
  <h1>Herb Card – Load & Merge</h1>

  <div class="row">
    <!-- Left: loader + paste + controls -->
    <div class="card">
      <div class="section">
        <div class="pill">1) Load your existing herbs.json</div>
        <input id="fileInput" type="file" accept=".json,application/json" />
        <span id="baseStatus" class="pill">No file loaded</span>
      </div>

      <div class="section">
        <div class="pill">2) Paste new card(s) below (blank line between cards)</div>
      </div>
      <textarea id="input" placeholder="Paste blocks like:
ID: lakka
Name (FI): Lakka
Name (EN): Cloudberry
..."></textarea>

      <div class="section">
        <button id="parseBtn">Parse</button>
        <label><input type="checkbox" id="overwriteDupes" /> Overwrite duplicates by id</label>
        <label><input type="checkbox" id="sortById" checked /> Sort by id</label>
        <span id="parseStatus" class="pill"></span>
      </div>

      <div class="section">
        <button id="mergeBtn" disabled>Merge into loaded JSON</button>
        <button id="downloadBtn" disabled>Download merged herbs.json</button>
        <span id="mergeStatus" class="pill"></span>
      </div>
    </div>

    <!-- Right: preview -->
    <div class="card">
      <div class="pill">Preview of parsed card(s)</div>
      <div id="preview" class="grid" aria-live="polite"></div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="pill">Merged JSON Output</div>
    <pre id="jsonOut">{}</pre>
  </div>

<script>
/* ===== helpers ===== */
const trim = s => (s ?? "").trim();
const toBool = v => /^(true|yes|1)$/i.test(String(v||"").trim());
const mapKey = (rawKey) => trim(rawKey).toLowerCase().replaceAll("–","-").replaceAll("—","-");

const FIELD_MAP = {
  "id": "id",
  "name (fi)": "name.fi",
  "name (en)": "name.en",
  "scientific name": "scientific_name",
  "found (fi)": "found.fi",
  "found (en)": "found.en",
  "collecting season (fi)": "collecting_season.fi",
  "collecting season (en)": "collecting_season.en",
  "parts (fi)": "parts.fi",
  "parts (en)": "parts.en",
  "uses (fi)": "uses.fi",
  "uses (en)": "uses.en",
  "safety (fi)": "safety.fi",
  "safety (en)": "safety.en",
  "other (fi)": "other.fi",
  "other (en)": "other.en",
  "store bought": "store_bought",
  "toxic": "toxic"
};

function setPath(obj, path, value) {
  const parts = path.split(".");
  let cur = obj;
  for (let i = 0; i < parts.length - 1; i++) {
    const p = parts[i];
    if (!cur[p] || typeof cur[p] !== "object") cur[p] = {};
    cur = cur[p];
  }
  cur[parts[parts.length - 1]] = value;
}

function parseOneBlock(blockText) {
  const out = {
    id: "", name: { fi: "", en: "" }, scientific_name: "",
    found: { fi: "", en: "" }, collecting_season: { fi: "", en: "" },
    parts: { fi: "", en: "" }, uses: { fi: "", en: "" },
    safety: { fi: "", en: "" }, other: { fi: "", en: "" },
    store_bought: false, toxic: false
  };
  const lines = blockText.split(/\r?\n/).filter(l => trim(l).length);
  for (const line of lines) {
    const m = line.match(/^\s*([^:]+):\s*(.*)\s*$/);
    if (!m) continue;
    const rawKey = mapKey(m[1]);
    const val = trim(m[2]);
    const path = FIELD_MAP[rawKey];
    if (!path) continue;
    if (path === "store_bought" || path === "toxic") setPath(out, path, toBool(val));
    else if (path === "scientific_name") setPath(out, path, val.replace(/\s+/g, " ").trim());
    else setPath(out, path, val);
  }
  return out;
}

function validateCard(card) {
  const missing = [];
  if (!card.id) missing.push("id");
  if (!card.name.fi) missing.push("name.fi");
  if (!card.name.en) missing.push("name.en");
  if (!card.scientific_name) missing.push("scientific_name");
  if (!card.found.fi) missing.push("found.fi");
  if (!card.found.en) missing.push("found.en");
  if (!card.collecting_season.fi) missing.push("collecting_season.fi");
  if (!card.collecting_season.en) missing.push("collecting_season.en");
  if (!card.parts.fi) missing.push("parts.fi");
  if (!card.parts.en) missing.push("parts.en");
  if (!card.uses.fi) missing.push("uses.fi");
  if (!card.uses.en) missing.push("uses.en");
  if (!card.safety.fi) missing.push("safety.fi");
  if (!card.safety.en) missing.push("safety.en");
  if (!card.other.fi) missing.push("other.fi");
  if (!card.other.en) missing.push("other.en");
  return missing;
}

function escapeHtml(s) {
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

function renderPreview(cards) {
  const host = document.getElementById("preview");
  host.innerHTML = "";
  cards.forEach((c, idx) => {
    const missing = validateCard(c);
    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
        <div class="pill ${missing.length ? "warn" : "ok"}">
          ${missing.length ? `Needs: ${missing.join(", ")}` : "Looks good"}
        </div>
        <div class="pill">#${idx+1}</div>
        <div class="pill">id: ${escapeHtml(c.id)}</div>
      </div>
      <div class="kv"><b>Name (FI)</b><div>${escapeHtml(c.name.fi)}</div></div>
      <div class="kv"><b>Name (EN)</b><div>${escapeHtml(c.name.en)}</div></div>
      <div class="kv"><b>Scientific</b><div><em>${escapeHtml(c.scientific_name)}</em></div></div>
      <div class="kv"><b>Found (FI)</b><div>${escapeHtml(c.found.fi)}</div></div>
      <div class="kv"><b>Found (EN)</b><div>${escapeHtml(c.found.en)}</div></div>
      <div class="kv"><b>Collect (FI)</b><div>${escapeHtml(c.collecting_season.fi)}</div></div>
      <div class="kv"><b>Collect (EN)</b><div>${escapeHtml(c.collecting_season.en)}</div></div>
      <div class="kv"><b>Parts (FI)</b><div>${escapeHtml(c.parts.fi)}</div></div>
      <div class="kv"><b>Parts (EN)</b><div>${escapeHtml(c.parts.en)}</div></div>
      <div class="kv"><b>Uses (FI)</b><div>${escapeHtml(c.uses.fi)}</div></div>
      <div class="kv"><b>Uses (EN)</b><div>${escapeHtml(c.uses.en)}</div></div>
      <div class="kv"><b>Safety (FI)</b><div>${escapeHtml(c.safety.fi)}</div></div>
      <div class="kv"><b>Safety (EN)</b><div>${escapeHtml(c.safety.en)}</div></div>
      <div class="kv"><b>Other (FI)</b><div>${escapeHtml(c.other.fi)}</div></div>
      <div class="kv"><b>Other (EN)</b><div>${escapeHtml(c.other.en)}</div></div>
      <div class="kv"><b>Store Bought</b><div>${c.store_bought}</div></div>
      <div class="kv"><b>Toxic</b><div>${c.toxic}</div></div>
    `;
    host.appendChild(el);
  });
}

/* ===== UI state ===== */
const fileInput = document.getElementById("fileInput");
const baseStatus = document.getElementById("baseStatus");
const input = document.getElementById("input");
const parseBtn = document.getElementById("parseBtn");
const parseStatus = document.getElementById("parseStatus");
const overwriteDupes = document.getElementById("overwriteDupes");
const sortById = document.getElementById("sortById");
const mergeBtn = document.getElementById("mergeBtn");
const downloadBtn = document.getElementById("downloadBtn");
const mergeStatus = document.getElementById("mergeStatus");
const jsonOut = document.getElementById("jsonOut");

let baseData = { version: 3, language_default: "fi", herbs: [] };
let parsedCards = [];
let mergedData = null;

/* Load existing herbs.json */
fileInput.addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  try {
    const text = await file.text();
    const json = JSON.parse(text);
    if (!Array.isArray(json?.herbs)) throw new Error("No 'herbs' array found");
    baseData = json;
    baseStatus.textContent = `Loaded: ${file.name} (${json.herbs.length} herbs)`;
    baseStatus.className = "pill ok";
    enableMergeIfReady();
  } catch (err) {
    baseStatus.textContent = `Load failed: ${err.message}`;
    baseStatus.className = "pill bad";
  }
});

/* Parse pasted blocks */
parseBtn.addEventListener("click", () => {
  const txt = input.value.trim();
  if (!txt) { set(parseStatus, "Paste something first", "bad"); return; }
  const chunks = txt
    .split(/\n(?=ID\s*:)|\n\s*\n/g)
    .map(s => s.trim())
    .filter(Boolean);

  parsedCards = chunks.map(parseOneBlock);
  renderPreview(parsedCards);

  set(parseStatus, `Parsed ${parsedCards.length} card(s)`, "ok");
  enableMergeIfReady();
});

/* Merge logic */
mergeBtn.addEventListener("click", () => {
  const base = JSON.parse(JSON.stringify(baseData)); // clone
  if (!Array.isArray(base.herbs)) base.herbs = [];
  const index = new Map(base.herbs.map(h => [h.id, h]));
  let added = 0, updated = 0, skipped = 0;

  for (const card of parsedCards) {
    if (!card.id) { skipped++; continue; }
    if (index.has(card.id)) {
      if (overwriteDupes.checked) {
        // overwrite existing
        const i = base.herbs.findIndex(h => h.id === card.id);
        base.herbs[i] = card;
        updated++;
      } else {
        skipped++;
      }
    } else {
      base.herbs.push(card);
      index.set(card.id, card);
      added++;
    }
  }

  if (sortById.checked) {
    base.herbs.sort((a,b)=> a.id.localeCompare(b.id, 'fi'));
  }

  mergedData = base;
  jsonOut.textContent = JSON.stringify(mergedData, null, 2);
  set(mergeStatus, `Merged: +${added} added, ${updated} updated, ${skipped} skipped`, "ok");
  downloadBtn.disabled = false;
});

/* Download merged file */
downloadBtn.addEventListener("click", () => {
  if (!mergedData) { set(mergeStatus, "Nothing to download yet", "bad"); return; }
  const blob = new Blob([JSON.stringify(mergedData, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "herbs.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  set(mergeStatus, "Download started", "ok");
});

/* helpers */
function set(el, text, kind) { el.textContent = text; el.className = `pill ${kind||""}`; }
function enableMergeIfReady() {
  mergeBtn.disabled = !(baseData?.herbs?.length >= 0 && parsedCards.length > 0);
  downloadBtn.disabled = !mergedData;
}
</script>
</body>
</html>
