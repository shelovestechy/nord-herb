<!doctype html>
<html lang="fi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Herb Editor Lite (offline)</title>
<style>
  :root{
    --bg:#0e0e12; --panel:#16161d; --ink:#f3e8ff; --muted:#b8b2c6;
    --accent:#ff7ad9; --accent-2:#9be7ff; --ok:#8aff9b; --warn:#ffd36b;
    --bad:#ff8a8a; --chip:#232330; --chip-ink:#d9d4e8;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:8px 0 16px}
  .panel{background:var(--panel);border:1px solid #262636;border-radius:14px;padding:14px}
  h1{font-size:22px;margin:8px 0 12px}
  h2{font-size:18px;margin:8px 0}
  label{display:block;font-weight:600;margin:10px 0 6px;color:var(--muted)}
  input[type="text"],textarea,select{
    width:100%;background:#11131a;border:1px solid #2b2b3b;color:var(--ink);
    border-radius:10px;padding:10px 12px;outline:none
  }
  input[type="checkbox"]{transform:scale(1.2);margin-right:8px}
  textarea{min-height:70px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .pill{display:inline-flex;align-items:center;background:var(--chip);color:var(--chip-ink);
    border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:13px}
  .btn{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#0b0b0f;
    border:none;border-radius:999px;padding:10px 16px;font-weight:700;cursor:pointer}
  .btn.subtle{background:#23233a;color:var(--ink);border:1px solid #2c2c3c}
  .btn.warn{background:var(--warn);color:#2b2200}
  .btn.ok{background:var(--ok);color:#07300f}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .list{max-height:420px;overflow:auto;border:1px solid #24243a;border-radius:12px;padding:8px}
  .item{display:flex;justify-content:space-between;gap:8px;padding:8px;border-radius:10px;cursor:pointer}
  .item:hover{background:#1b1b27}
  .badge{font-size:12px;padding:3px 8px;border-radius:999px;background:#27273a;color:#bfc3d9}
  .ok{color:var(--ok)} .bad{color:var(--bad)}
  .muted{color:var(--muted)}
  .footer{margin:18px 0 40px;color:var(--muted);font-size:14px}
  .sticky{position:sticky;top:8px}
  @media (max-width:900px){.grid,.row,.row-3{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h1>ðŸŒ¿ Herb Editor Lite <span class="muted">(offline)</span></h1>
  <div class="toolbar">
    <input id="fileInput" type="file" accept=".json" class="btn subtle">
    <button id="loadDemo" class="btn subtle">Lataa esimerkkirakenne</button>
    <button id="exportJson" class="btn">Export JSON</button>
    <button id="exportCsv" class="btn subtle">Export CSV</button>
    <label class="pill"><input id="showStubsOnly" type="checkbox">NÃ¤ytÃ¤ vain stubit</label>
    <input id="searchBox" type="text" placeholder="Haku: nimi / tieteellinen / tagi" style="flex:1;min-width:220px;background:#11131a;border:1px solid #2b2b3b;color:#fff;border-radius:999px;padding:10px 14px">
  </div>

  <div class="grid">
    <div class="panel sticky">
      <h2>Lista (<span id="count">0</span>)</h2>
      <div id="list" class="list"></div>
    </div>

    <div class="panel">
      <h2 id="editorTitle">Muokkaus</h2>
      <div class="row">
        <div>
          <label>ID</label>
          <input id="f-id" type="text" placeholder="esim. nettle">
        </div>
        <div>
          <label>Tieteellinen nimi</label>
          <input id="f-sci" type="text" placeholder="Urtica dioica">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Nimi (FI)</label>
          <input id="f-name-fi" type="text" placeholder="Nokkonen">
        </div>
        <div>
          <label>Name (EN)</label>
          <input id="f-name-en" type="text" placeholder="Nettle">
        </div>
      </div>

      <div class="row-3">
        <label class="pill"><input id="f-native" type="checkbox">Luonnonvarainen Suomessa</label>
        <label class="pill"><input id="f-store" type="checkbox">Kauppayrtti</label>
        <div>
          <label>Jokamiehenoikeus (FI)</label>
          <select id="f-rights">
            <option value="allowed">allowed</option>
            <option value="restricted">restricted</option>
            <option value="private_only">private_only</option>
            <option value="unknown">unknown</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Found (FI)</label>
          <input id="f-found-fi" type="text" placeholder="Yleinen koko Suomessa...">
        </div>
        <div>
          <label>Found (EN)</label>
          <input id="f-found-en" type="text" placeholder="Common throughout Finland...">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Osat (FI) â€” pilkulla eroteltu</label>
          <input id="f-parts-fi" type="text" placeholder="Nuoret lehdet, varret, siemenet, juuret">
        </div>
        <div>
          <label>Parts (EN) â€” comma separated</label>
          <input id="f-parts-en" type="text" placeholder="Young leaves, stems, seeds, roots">
        </div>
      </div>

      <div class="row">
        <div>
          <label>KÃ¤yttÃ¶ (FI) â€” pilkulla eroteltu</label>
          <input id="f-uses-fi" type="text" placeholder="Tee, siirappi, voide">
        </div>
        <div>
          <label>Uses (EN) â€” comma separated</label>
          <input id="f-uses-en" type="text" placeholder="Tea, syrup, salve">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Turvallisuus (FI)</label>
          <textarea id="f-safety-fi" placeholder="VÃ¤ltÃ¤ raskauden aikana..."></textarea>
        </div>
        <div>
          <label>Safety (EN)</label>
          <textarea id="f-safety-en" placeholder="Avoid during pregnancy..."></textarea>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Muut (FI)</label>
          <textarea id="f-other-fi" placeholder="Sallittu kerÃ¤tÃ¤ jokamiehenoikeuksin..."></textarea>
        </div>
        <div>
          <label>Other (EN)</label>
          <textarea id="f-other-en" placeholder="Allowed under everymanâ€™s rights..."></textarea>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Turvataso</label>
          <select id="f-safety-level">
            <option value="info">info</option>
            <option value="caution">caution</option>
            <option value="avoid_in_pregnancy">avoid_in_pregnancy</option>
          </select>
        </div>
        <div>
          <label>Tagit (pilkuilla)</label>
          <input id="f-tags" type="text" placeholder="wild, finland, tea">
        </div>
      </div>

      <div class="toolbar" style="justify-content:flex-end;margin-top:16px">
        <button id="markVerified" class="btn ok">Merkitse Verified</button>
        <button id="resetForm" class="btn warn">TyhjennÃ¤ lomake</button>
        <button id="saveItem" class="btn">Tallenna muokkaus</button>
      </div>

      <div id="chips" style="margin-top:8px"></div>
      <div class="footer">V3-skeema: <code>name.fi/en</code>, <code>parts_used/uses_make</code> taulukkoina, <code>found.fi/en</code> voi olla <code>null</code>. VÃ¤ltÃ¤ tyhjiÃ¤ stringejÃ¤, kÃ¤ytÃ¤ <code>null</code>.</div>
    </div>
  </div>
</div>

<script>
let data = null;
let herbs = [];
let selectedIndex = -1;

const $ = (id)=>document.getElementById(id);
const els = {
  fileInput: $('fileInput'),
  loadDemo: $('loadDemo'),
  exportJson: $('exportJson'),
  exportCsv: $('exportCsv'),
  showStubsOnly: $('showStubsOnly'),
  searchBox: $('searchBox'),
  list: $('list'),
  count: $('count'),
  editorTitle: $('editorTitle'),
  // fields:
  id: $('f-id'), sci: $('f-sci'),
  nameFi: $('f-name-fi'), nameEn: $('f-name-en'),
  native: $('f-native'), store: $('f-store'), rights: $('f-rights'),
  foundFi: $('f-found-fi'), foundEn: $('f-found-en'),
  partsFi: $('f-parts-fi'), partsEn: $('f-parts-en'),
  usesFi: $('f-uses-fi'), usesEn: $('f-uses-en'),
  safetyFi: $('f-safety-fi'), safetyEn: $('f-safety-en'),
  otherFi: $('f-other-fi'), otherEn: $('f-other-en'),
  safetyLevel: $('f-safety-level'),
  tags: $('f-tags'),
  chips: $('chips'),
  saveItem: $('saveItem'),
  resetForm: $('resetForm'),
  markVerified: $('markVerified'),
};

function t(obj, lang='fi', fb='en'){ return obj?.[lang] ?? obj?.[fb] ?? ''; }
function arrFromInput(v){ return v.split(',').map(s=>s.trim()).filter(Boolean); }
function inputFromArr(a){ return (a||[]).join(', '); }

function renderList(){
  const q = els.searchBox.value.trim().toLowerCase();
  const stubsOnly = els.showStubsOnly.checked;
  els.list.innerHTML = '';
  let filtered = herbs.map((h,i)=>({h,i}));

  if(q){
    filtered = filtered.filter(({h})=>{
      const tags = (h.tags||[]).join(' ').toLowerCase();
      return (h.id||'').toLowerCase().includes(q)
        || (h.scientific_name||'').toLowerCase().includes(q)
        || t(h.name,'fi','en').toLowerCase().includes(q)
        || t(h.name,'en','fi').toLowerCase().includes(q)
        || tags.includes(q);
    });
  }
  if(stubsOnly){
    filtered = filtered.filter(({h})=> (h.completion_status||'stub')==='stub');
  }

  els.count.textContent = filtered.length;

  for(const {h,i} of filtered){
    const div = document.createElement('div');
    div.className = 'item';
    div.onclick = ()=>selectIndex(i);
    const nm = t(h.name) || h.id;
    const status = h.completion_status==='verified' ? '<span class="badge">verified</span>' : '<span class="badge">stub</span>';
    const sci = h.scientific_name ? `<span class="muted">${h.scientific_name}</span>` : `<span class="muted">â€”</span>`;
    div.innerHTML = `
      <div>
        <div><strong>${nm ?? ''}</strong> ${status}</div>
        <div style="font-size:13px">${sci}</div>
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
        ${(h.tags||[]).slice(0,4).map(tag=>`<span class="badge">${tag}</span>`).join('')}
      </div>
    `;
    els.list.appendChild(div);
  }
}

function selectIndex(i){
  selectedIndex = i;
  const h = herbs[i];
  els.editorTitle.textContent = `Muokkaus â€” ${t(h.name)||h.id}`;
  els.id.value = h.id || '';
  els.sci.value = h.scientific_name || '';
  els.nameFi.value = t(h.name,'fi','fi');
  els.nameEn.value = t(h.name,'en','en');
  els.native.checked = !!h?.origin?.native_in_finland;
  els.store.checked = !!h?.origin?.store_bought;
  els.rights.value = h.foraging_rights_fi || 'unknown';
  els.foundFi.value = (h.found?.fi ?? '') || '';
  els.foundEn.value = (h.found?.en ?? '') || '';
  els.partsFi.value = inputFromArr(h.parts_used?.fi);
  els.partsEn.value = inputFromArr(h.parts_used?.en);
  els.usesFi.value = inputFromArr(h.uses_make?.fi);
  els.usesEn.value = inputFromArr(h.uses_make?.en);
  els.safetyFi.value = h.safety?.fi ?? '';
  els.safetyEn.value = h.safety?.en ?? '';
  els.otherFi.value = h.other?.fi ?? '';
  els.otherEn.value = h.other?.en ?? '';
  els.safetyLevel.value = h.safety_level || 'info';
  els.tags.value = (h.tags||[]).join(', ');
  renderChips(h);
}

function renderChips(h){
  const chips = [];
  if(h?.origin?.native_in_finland) chips.push('ðŸ‡«ðŸ‡® wild/native');
  if(h?.origin?.store_bought) chips.push('ðŸ›’ store');
  if(h.foraging_rights_fi) chips.push('ðŸ“œ ' + h.foraging_rights_fi);
  (h.tags||[]).forEach(tag=>chips.push('#'+tag));
  els.chips.innerHTML = chips.map(c=>`<span class="pill">${c}</span>`).join('');
}

function saveCurrent(){
  if(selectedIndex<0) return;
  const h = herbs[selectedIndex];
  h.id = els.id.value.trim() || h.id;
  h.scientific_name = els.sci.value.trim() || null;
  h.name = { fi: els.nameFi.value.trim(), en: els.nameEn.value.trim() };
  h.origin = { native_in_finland: els.native.checked, store_bought: els.store.checked };
  const fiFound = els.foundFi.value.trim(); const enFound = els.foundEn.value.trim();
  h.found = (fiFound || enFound) ? { fi: fiFound || null, en: enFound || null } : { fi: null, en: null };
  h.parts_used = { fi: arrFromInput(els.partsFi.value), en: arrFromInput(els.partsEn.value) };
  h.uses_make = { fi: arrFromInput(els.usesFi.value), en: arrFromInput(els.usesEn.value) };
  h.safety = { fi: els.safetyFi.value.trim(), en: els.safetyEn.value.trim() };
  h.other = { fi: els.otherFi.value.trim(), en: els.otherEn.value.trim() };
  h.safety_level = els.safetyLevel.value;
  h.foraging_rights_fi = els.rights.value;
  h.tags = arrFromInput(els.tags.value.toLowerCase());
  renderChips(h);
  renderList();
}

function markVerified(){
  if(selectedIndex<0) return;
  herbs[selectedIndex].completion_status = 'verified';
  renderList();
}

function resetForm(){
  selectedIndex = -1;
  [
    els.id,els.sci,els.nameFi,els.nameEn,els.foundFi,els.foundEn,
    els.partsFi,els.partsEn,els.usesFi,els.usesEn,
    els.safetyFi,els.safetyEn,els.otherFi,els.otherEn,els.tags
  ].forEach(el=>el.value='');
  els.native.checked=false; els.store.checked=false;
  els.rights.value='unknown'; els.safetyLevel.value='info';
  els.editorTitle.textContent='Muokkaus';
  els.chips.innerHTML='';
}

function exportFile(filename, content, mime='application/json'){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([content],{type:mime}));
  a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
}

function exportJson(){
  if(!data) return;
  const out = { ...data, herbs };
  exportFile('herbs_v3_175_updated.json', JSON.stringify(out,null,2));
}

function csvEsc(s){
  if(s==null) return '';
  s = String(s);
  if(s.includes('"')||s.includes(',')||s.includes('\n')) return '"' + s.replace(/"/g,'""') + '"';
  return s;
}

function exportCsv(){
  // Kevyt CSV (id, fi/en nimi, sci, tags, status)
  const rows = [['id','name_fi','name_en','scientific','native_fi','store_bought','found_fi','found_en','parts_fi','parts_en','uses_fi','uses_en','safety_fi','safety_en','other_fi','other_en','rights_fi','safety_level','tags','status']];
  for(const h of herbs){
    rows.push([
      h.id,
      t(h.name,'fi','fi'),
      t(h.name,'en','en'),
      h.scientific_name||'',
      (h.origin?.native_in_finland?1:0),
      (h.origin?.store_bought?1:0),
      h.found?.fi||'',
      h.found?.en||'',
      (h.parts_used?.fi||[]).join('|'),
      (h.parts_used?.en||[]).join('|'),
      (h.uses_make?.fi||[]).join('|'),
      (h.uses_make?.en||[]).join('|'),
      h.safety?.fi||'',
      h.safety?.en||'',
      h.other?.fi||'',
      h.other?.en||'',
      h.foraging_rights_fi||'',
      h.safety_level||'info',
      (h.tags||[]).join('|'),
      h.completion_status||'stub'
    ].map(csvEsc).join(','));
  }
  exportFile('herbs_edit.csv', rows.join('\n'), 'text/csv');
}

function loadFromObject(obj){
  data = obj;
  herbs = Array.isArray(obj?.herbs) ? JSON.parse(JSON.stringify(obj.herbs)) : [];
  selectedIndex = -1;
  renderList();
  resetForm();
}

els.fileInput.addEventListener('change', (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  const r = new FileReader();
  r.onload = ()=> {
    try{
      const obj = JSON.parse(r.result);
      if(obj.version!==3) alert('Varoitus: version ei ole 3 (jatketaan silti).');
      loadFromObject(obj);
    }catch(err){ alert('JSON-virhe: ' + err.message); }
  };
  r.readAsText(file);
});

els.loadDemo.addEventListener('click', ()=>{
  // Kevyt demo-rakenne jos haluat testata ilman tiedostoa
  loadFromObject({version:3,language_default:"fi",herbs:[
    {id:"nettle", name:{fi:"Nokkonen",en:"Nettle"}, scientific_name:"Urtica dioica",
     origin:{native_in_finland:true,store_bought:false},
     found:{fi:"Yleinen koko Suomessa",en:"Common in Finland"},
     parts_used:{fi:["Lehdet"],en:["Leaves"]},
     uses_make:{fi:["Tee"],en:["Tea"]},
     safety:{fi:"KÃ¤ytÃ¤ hanskoja.",en:"Use gloves."},
     safety_level:"info", other:{fi:"",en:""}, foraging_rights_fi:"allowed", tags:["wild","tea"], completion_status:"verified"
    },
    {id:"stub-001", name:{fi:"TÃ¤ydennÃ¤ yrtti 1",en:"Fill herb 1"}, scientific_name:null,
     origin:{native_in_finland:false,store_bought:false},
     found:{fi:null,en:null},
     parts_used:{fi:[],en:[]}, uses_make:{fi:[],en:[]},
     safety:{fi:"",en:""}, safety_level:"info", other:{fi:"",en:""},
     foraging_rights_fi:"unknown", tags:["stub"], completion_status:"stub"
    }
  ]});
});

els.saveItem.addEventListener('click', saveCurrent);
els.resetForm.addEventListener('click', resetForm);
els.markVerified.addEventListener('click', ()=>{ markVerified(); saveCurrent(); });
els.searchBox.addEventListener('input', renderList);
els.showStubsOnly.addEventListener('change', renderList);
els.exportJson.addEventListener('click', exportJson);
els.exportCsv.addEventListener('click', exportCsv);
</script>
</body>
</html>
